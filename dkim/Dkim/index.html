<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Dkim (dkim.Dkim)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.0-342-g7e488de"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><nav><a href="../index.html">Up</a> – <a href="../index.html">dkim</a> &#x00BB; Dkim</nav><header><h1>Module <code>Dkim</code></h1></header><div class="content"><div class="spec module" id="module-Sigs" class="anchored"><a href="#module-Sigs" class="anchor"></a><code><span class="keyword">module</span> <a href="Sigs/index.html">Sigs</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec type" id="type-or_err" class="anchored"><a href="#type-or_err" class="anchor"></a><code><span class="keyword">type</span> <span>(+'a, 'err) or_err</span> = <span><span>(<span class="type-var">'a</span>, <span>[&gt; <span class="xref-unresolved">Rresult</span>.R.msg ]</span> <span class="keyword">as</span> 'err)</span> <span class="xref-unresolved">Stdlib</span>.result</span></code></div><div class="spec type" id="type-newline" class="anchored"><a href="#type-newline" class="anchor"></a><code><span class="keyword">type</span> newline = </code><table><tr id="type-newline.CRLF" class="anchored"><td class="def variant constructor"><a href="#type-newline.CRLF" class="anchor"></a><code>| <span class="constructor">CRLF</span></code></td></tr><tr id="type-newline.LF" class="anchored"><td class="def variant constructor"><a href="#type-newline.LF" class="anchor"></a><code>| <span class="constructor">LF</span></code></td></tr></table></div><div class="spec type" id="type-map" class="anchored"><a href="#type-map" class="anchor"></a><code><span class="keyword">type</span> map</code></div><div class="spec type" id="type-signed" class="anchored"><a href="#type-signed" class="anchor"></a><code><span class="keyword">type</span> signed</code></div><div class="spec type" id="type-unsigned" class="anchored"><a href="#type-unsigned" class="anchor"></a><code><span class="keyword">type</span> unsigned</code></div><div class="spec type" id="type-dkim" class="anchored"><a href="#type-dkim" class="anchor"></a><code><span class="keyword">type</span> <span>'a dkim</span></code></div><div class="spec type" id="type-server" class="anchored"><a href="#type-server" class="anchor"></a><code><span class="keyword">type</span> server</code></div><div class="spec type" id="type-body" class="anchored"><a href="#type-body" class="anchor"></a><code><span class="keyword">type</span> body</code></div><div class="spec value" id="val-pp_dkim" class="anchored"><a href="#val-pp_dkim" class="anchor"></a><code><span class="keyword">val</span> pp_dkim : <span><span><span class="type-var">'a</span> <a href="index.html#type-dkim">dkim</a></span> <span class="xref-unresolved">Fmt</span>.t</span></code></div><div class="spec value" id="val-pp_server" class="anchored"><a href="#val-pp_server" class="anchor"></a><code><span class="keyword">val</span> pp_server : <span><a href="index.html#type-server">server</a> <span class="xref-unresolved">Fmt</span>.t</span></code></div><div class="spec type" id="type-extracted" class="anchored"><a href="#type-extracted" class="anchor"></a><code><span class="keyword">type</span> extracted = {</code><table><tr id="type-extracted.dkim_fields" class="anchored"><td class="def record field"><a href="#type-extracted.dkim_fields" class="anchor"></a><code>dkim_fields : <span><span>(<span class="xref-unresolved">Mrmime</span>.Field_name.t * <span class="xref-unresolved">Unstrctrd</span>.t * <a href="index.html#type-map">map</a>)</span> list</span>;</code></td></tr><tr id="type-extracted.fields" class="anchored"><td class="def record field"><a href="#type-extracted.fields" class="anchor"></a><code>fields : <span><span>(<span class="xref-unresolved">Mrmime</span>.Field_name.t * <span class="xref-unresolved">Unstrctrd</span>.t)</span> list</span>;</code></td></tr><tr id="type-extracted.prelude" class="anchored"><td class="def record field"><a href="#type-extracted.prelude" class="anchor"></a><code>prelude : string;</code></td></tr></table><code>}</code></div><div><div class="spec value" id="val-extract_dkim" class="anchored"><a href="#val-extract_dkim" class="anchor"></a><code><span class="keyword">val</span> extract_dkim : <span>?&#8288;newline:<a href="index.html#type-newline">newline</a></span> <span>&#45;&gt;</span> <span class="type-var">'flow</span> <span>&#45;&gt;</span> <span><span class="type-var">'t</span> <a href="Sigs/index.html#type-state">Sigs.state</a></span> <span>&#45;&gt;</span> <span>(<span class="keyword">module</span> <a href="Sigs/module-type-FLOW/index.html">Sigs.FLOW</a> <span class="keyword">with</span> <span class="keyword">type</span> <a href="Sigs/module-type-FLOW/index.html#type-backend">backend</a> = <span class="type-var">'t</span> <span class="keyword">and</span> <span class="keyword">type</span> <a href="Sigs/module-type-FLOW/index.html#type-flow">flow</a> = <span class="type-var">'flow</span>)</span> <span>&#45;&gt;</span> <span><span>(<span><span>(<a href="index.html#type-extracted">extracted</a>, <span class="type-var">_</span>)</span> <a href="index.html#type-or_err">or_err</a></span>, <span class="type-var">'t</span>)</span> <a href="Sigs/index.html#type-io">Sigs.io</a></span></code></div><div><p><code>extract_dkim ?newline flow state (module Flow)</code> reads <code>flow</code> with Input/Output scheduler represented by <code>state</code> and primitives implemented by <code>(module Flow)</code>. <code>?newline</code> specifies kind of contents (<code>CRLF</code> from network or <code>LF</code> from database like <i>maildir</i>).</p><p>It tries to extract <code>DKIM-Signature</code> fields with values, others fields and give a prelude of the body of the email (given by <code>flow</code>).</p></div></div><div><div class="spec value" id="val-post_process_dkim" class="anchored"><a href="#val-post_process_dkim" class="anchor"></a><code><span class="keyword">val</span> post_process_dkim : <a href="index.html#type-map">map</a> <span>&#45;&gt;</span> <span><span>(<span><a href="index.html#type-signed">signed</a> <a href="index.html#type-dkim">dkim</a></span>, <span class="type-var">_</span>)</span> <a href="index.html#type-or_err">or_err</a></span></code></div><div><p><code>post_process_dkim map</code> from an already parsed <code>DKIM-Signature</code> represented by <a href="index.html#type-map"><code>map</code></a>, we compute a post process analyze (check required/optional well formed values) and return a safe representation of <code>DKIM-Signature</code>, <a href="index.html#type-dkim"><code>dkim</code></a>, which can be used by <a href="index.html#val-verify"><code>verify</code></a>.</p></div></div><div><div class="spec value" id="val-selector" class="anchored"><a href="#val-selector" class="anchor"></a><code><span class="keyword">val</span> selector : <span><span class="type-var">'a</span> <a href="index.html#type-dkim">dkim</a></span> <span>&#45;&gt;</span> <span><span>[ `raw ]</span> <span class="xref-unresolved">Domain_name</span>.t</span></code></div><div><p><code>selector dkim</code> returns the selector of the DKIM-Signature field.</p><p>Selectors might indicate the names of office locations, the signing date, or even an individual user.</p></div></div><div><div class="spec value" id="val-domain" class="anchored"><a href="#val-domain" class="anchor"></a><code><span class="keyword">val</span> domain : <span><span class="type-var">'a</span> <a href="index.html#type-dkim">dkim</a></span> <span>&#45;&gt;</span> <span><span>[ `raw ]</span> <span class="xref-unresolved">Domain_name</span>.t</span></code></div><div><p><code>domain dkim</code> returns the domain which signed the mail.</p></div></div><div><div class="spec value" id="val-domain_name" class="anchored"><a href="#val-domain_name" class="anchor"></a><code><span class="keyword">val</span> domain_name : <span><span class="type-var">'a</span> <a href="index.html#type-dkim">dkim</a></span> <span>&#45;&gt;</span> <span><span>(<span><span>[ `raw ]</span> <span class="xref-unresolved">Domain_name</span>.t</span>, <span>[&gt; <span>`Msg of string</span> ]</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span></code></div><div><p><code>domain_name dkim</code> returns the full domain-name where the DNS TXT record can be get.</p></div></div><div><div class="spec value" id="val-extract_server" class="anchored"><a href="#val-extract_server" class="anchor"></a><code><span class="keyword">val</span> extract_server : <span class="type-var">'t</span> <span>&#45;&gt;</span> <span><span class="type-var">'backend</span> <a href="Sigs/index.html#type-state">Sigs.state</a></span> <span>&#45;&gt;</span> <span>(<span class="keyword">module</span> <a href="Sigs/module-type-DNS/index.html">Sigs.DNS</a> <span class="keyword">with</span> <span class="keyword">type</span> <a href="Sigs/module-type-DNS/index.html#type-backend">backend</a> = <span class="type-var">'backend</span> <span class="keyword">and</span> <span class="keyword">type</span> <a href="Sigs/module-type-DNS/index.html#type-t">t</a> = <span class="type-var">'t</span>)</span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="index.html#type-dkim">dkim</a></span> <span>&#45;&gt;</span> <span><span>(<span><span>(<a href="index.html#type-map">map</a>, <span class="type-var">_</span>)</span> <a href="index.html#type-or_err">or_err</a></span>, <span class="type-var">'backend</span>)</span> <a href="Sigs/index.html#type-io">Sigs.io</a></span></code></div><div><p><code>extract_server dns state (module Dns) dkim</code> gets public-key noticed by <code>dkim</code> from authority server over DNS protocol (with Input/Output scheduler represented by <code>state</code> and primitives implemented by <code>(module Dns)</code>).</p></div></div><div><div class="spec value" id="val-post_process_server" class="anchored"><a href="#val-post_process_server" class="anchor"></a><code><span class="keyword">val</span> post_process_server : <a href="index.html#type-map">map</a> <span>&#45;&gt;</span> <span><span>(<a href="index.html#type-server">server</a>, <span class="type-var">_</span>)</span> <a href="index.html#type-or_err">or_err</a></span></code></div><div><p><code>post_process_server map</code> from an already parsed TXT record (given by a DNS service) represented by <a href="index.html#type-map"><code>map</code></a>, we compute a post-process analyze (check required/optional well formed values) and return a safe representation of the public-key, <a href="index.html#type-server"><code>server</code></a>, which can be used by <a href="index.html#val-verify"><code>verify</code></a>.</p></div></div><div><div class="spec value" id="val-extract_body" class="anchored"><a href="#val-extract_body" class="anchor"></a><code><span class="keyword">val</span> extract_body : <span>?&#8288;newline:<a href="index.html#type-newline">newline</a></span> <span>&#45;&gt;</span> <span class="type-var">'flow</span> <span>&#45;&gt;</span> <span><span class="type-var">'backend</span> <a href="Sigs/index.html#type-state">Sigs.state</a></span> <span>&#45;&gt;</span> <span>(<span class="keyword">module</span> <a href="Sigs/module-type-FLOW/index.html">Sigs.FLOW</a> <span class="keyword">with</span> <span class="keyword">type</span> <a href="Sigs/module-type-FLOW/index.html#type-backend">backend</a> = <span class="type-var">'backend</span> <span class="keyword">and</span> <span class="keyword">type</span> <a href="Sigs/module-type-FLOW/index.html#type-flow">flow</a> = <span class="type-var">'flow</span>)</span> <span>&#45;&gt;</span> <span>prelude:string</span> <span>&#45;&gt;</span> <span><span>(<a href="index.html#type-body">body</a>, <span class="type-var">'backend</span>)</span> <a href="Sigs/index.html#type-io">Sigs.io</a></span></code></div><div><p><code>extract_body ?newline flow state (module Flow) ~prelude</code> extracts a thin representation of the body of the email. It should follow <a href="index.html#val-extract_dkim"><code>extract_dkim</code></a> with <code>prelude</code> and with <code>flow</code>, <code>state</code>, <code>(module Flow)</code> and <code>?newline</code> arguments. It returns a <a href="index.html#type-body"><code>body</code></a> which can be used by <a href="index.html#val-verify"><code>verify</code></a>.</p></div></div><div><div class="spec value" id="val-verify" class="anchored"><a href="#val-verify" class="anchor"></a><code><span class="keyword">val</span> verify : <span><span>(<span class="xref-unresolved">Mrmime</span>.Field_name.t * <span class="xref-unresolved">Unstrctrd</span>.t)</span> list</span> <span>&#45;&gt;</span> <span>(<span class="xref-unresolved">Mrmime</span>.Field_name.t * <span class="xref-unresolved">Unstrctrd</span>.t)</span> <span>&#45;&gt;</span> <span><a href="index.html#type-signed">signed</a> <a href="index.html#type-dkim">dkim</a></span> <span>&#45;&gt;</span> <a href="index.html#type-server">server</a> <span>&#45;&gt;</span> <a href="index.html#type-body">body</a> <span>&#45;&gt;</span> bool</code></div><div><p><code>verify fields (dkim_field_name, dkim_value) dkim server body</code> verifies the given email (represented by <a href="index.html#type-body"><code>body</code></a>. <code>fields</code> and <code>(dkim_field_name, dkim_value)</code>) with a signature <a href="index.html#type-dkim"><code>dkim</code></a> and the public-key represented by <a href="index.html#type-server"><code>server</code></a>.</p><p>It returns <code>true</code> if signature is correct or <code>false</code> if something is wrong.</p><p>Establishing the exact cause of a failed verification if difficult:</p><ul><li><code>selector</code> can not be found.</li><li>Public-key was updated.</li><li><code>DKIM-Signature</code> is not well-formed.</li><li>etc.</li></ul><p>At least, <code>dkim</code> provides some logs to highlight where the verification failed. Finally, the given email should be treated the same as all unverified email - regardless of whether or not it looks like it was signed.</p></div></div><div class="spec type" id="type-algorithm" class="anchored"><a href="#type-algorithm" class="anchor"></a><code><span class="keyword">type</span> algorithm = [ </code><table><tr id="type-algorithm.RSA" class="anchored"><td class="def constructor"><a href="#type-algorithm.RSA" class="anchor"></a><code>| </code><code>`RSA</code></td></tr></table><code> ]</code></div><div class="spec type" id="type-hash" class="anchored"><a href="#type-hash" class="anchor"></a><code><span class="keyword">type</span> hash = [ </code><table><tr id="type-hash.SHA1" class="anchored"><td class="def constructor"><a href="#type-hash.SHA1" class="anchor"></a><code>| </code><code>`SHA1</code></td></tr><tr id="type-hash.SHA256" class="anchored"><td class="def constructor"><a href="#type-hash.SHA256" class="anchor"></a><code>| </code><code>`SHA256</code></td></tr></table><code> ]</code></div><div class="spec type" id="type-canonicalization" class="anchored"><a href="#type-canonicalization" class="anchor"></a><code><span class="keyword">type</span> canonicalization = [ </code><table><tr id="type-canonicalization.Simple" class="anchored"><td class="def constructor"><a href="#type-canonicalization.Simple" class="anchor"></a><code>| </code><code>`Simple</code></td></tr><tr id="type-canonicalization.Relaxed" class="anchored"><td class="def constructor"><a href="#type-canonicalization.Relaxed" class="anchor"></a><code>| </code><code>`Relaxed</code></td></tr></table><code> ]</code></div><div class="spec type" id="type-query" class="anchored"><a href="#type-query" class="anchor"></a><code><span class="keyword">type</span> query = [ </code><table><tr id="type-query.DNS" class="anchored"><td class="def constructor"><a href="#type-query.DNS" class="anchor"></a><code>| </code><code>`DNS <span class="keyword">of</span> <span>[ `TXT ]</span></code></td></tr></table><code> ]</code></div><div class="spec value" id="val-v" class="anchored"><a href="#val-v" class="anchor"></a><code><span class="keyword">val</span> v : <span>?&#8288;version:int</span> <span>&#45;&gt;</span> <span>?&#8288;fields:<span><span class="xref-unresolved">Mrmime</span>.Field_name.t list</span></span> <span>&#45;&gt;</span> <span>selector:<span><span>[ `raw ]</span> <span class="xref-unresolved">Domain_name</span>.t</span></span> <span>&#45;&gt;</span> <span>?&#8288;algorithm:<a href="index.html#type-algorithm">algorithm</a></span> <span>&#45;&gt;</span> <span>?&#8288;hash:<a href="index.html#type-hash">hash</a></span> <span>&#45;&gt;</span> <span>?&#8288;canonicalization:<span>(<a href="index.html#type-canonicalization">canonicalization</a> * <a href="index.html#type-canonicalization">canonicalization</a>)</span></span> <span>&#45;&gt;</span> <span>?&#8288;length:int</span> <span>&#45;&gt;</span> <span>?&#8288;query:<a href="index.html#type-query">query</a></span> <span>&#45;&gt;</span> <span>?&#8288;timestamp:int64</span> <span>&#45;&gt;</span> <span>?&#8288;expiration:int64</span> <span>&#45;&gt;</span> <span><span>[ `raw ]</span> <span class="xref-unresolved">Domain_name</span>.t</span> <span>&#45;&gt;</span> <span><a href="index.html#type-unsigned">unsigned</a> <a href="index.html#type-dkim">dkim</a></span></code></div><div class="spec module" id="module-Encoder" class="anchored"><a href="#module-Encoder" class="anchor"></a><code><span class="keyword">module</span> <a href="Encoder/index.html">Encoder</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div><div class="spec value" id="val-sign" class="anchored"><a href="#val-sign" class="anchor"></a><code><span class="keyword">val</span> sign : <span>key:<span class="xref-unresolved">Mirage_crypto_pk</span>.Rsa.priv</span> <span>&#45;&gt;</span> <span>?&#8288;newline:<a href="index.html#type-newline">newline</a></span> <span>&#45;&gt;</span> <span class="type-var">'flow</span> <span>&#45;&gt;</span> <span><span class="type-var">'t</span> <a href="Sigs/index.html#type-state">Sigs.state</a></span> <span>&#45;&gt;</span> <span>(<span class="keyword">module</span> <a href="Sigs/module-type-FLOW/index.html">Sigs.FLOW</a> <span class="keyword">with</span> <span class="keyword">type</span> <a href="Sigs/module-type-FLOW/index.html#type-backend">backend</a> = <span class="type-var">'t</span> <span class="keyword">and</span> <span class="keyword">type</span> <a href="Sigs/module-type-FLOW/index.html#type-flow">flow</a> = <span class="type-var">'flow</span>)</span> <span>&#45;&gt;</span> <span><a href="index.html#type-unsigned">unsigned</a> <a href="index.html#type-dkim">dkim</a></span> <span>&#45;&gt;</span> <span><span>(<span><a href="index.html#type-signed">signed</a> <a href="index.html#type-dkim">dkim</a></span>, <span class="type-var">'t</span>)</span> <a href="Sigs/index.html#type-io">Sigs.io</a></span></code></div><div><p><code>sign ~key ~newline flow state (module Flow) dkim</code> returns a signed <a href="index.html#type-dkim"><code>dkim</code></a> value which can be serialized into the given email (represented by <code>flow</code>). According to <code>dkim</code>, it will sign some fields and the body.</p><p>The returned signed <a href="index.html#type-dkim"><code>dkim</code></a> can be serialized with:</p><pre><code>let dkim_field = Prettym.to_string Dkim.Encoder.as_field dkim </code></pre></div></div><div><div class="spec value" id="val-server_of_dkim" class="anchored"><a href="#val-server_of_dkim" class="anchor"></a><code><span class="keyword">val</span> server_of_dkim : <span>key:<span class="xref-unresolved">Mirage_crypto_pk</span>.Rsa.priv</span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="index.html#type-dkim">dkim</a></span> <span>&#45;&gt;</span> <a href="index.html#type-server">server</a></code></div><div><p><code>server_of_dkim</code> returns the required server value from a <a href="index.html#type-dkim"><code>dkim</code></a> value. The user is able to store the associated server value into the DNS TXT record with <a href="index.html#val-server_to_string"><code>server_to_string</code></a> such as:</p><pre><code>let str = Dkim.server_to_string (Dkim.server_of_dkim ~key dkim) in
nsupdate (Dkim.domain_name dkim) `TXT str</code></pre></div></div><div><div class="spec value" id="val-server_to_string" class="anchored"><a href="#val-server_to_string" class="anchor"></a><code><span class="keyword">val</span> server_to_string : <a href="index.html#type-server">server</a> <span>&#45;&gt;</span> string</code></div><div><p><code>server_to_string server</code> generates a <code>string</code> from the given <code>server</code> value to be able to store the string into the DNS TXT record.</p></div></div><aside><p>/</p></aside><div class="spec value" id="val-remove_signature_of_raw_dkim" class="anchored"><a href="#val-remove_signature_of_raw_dkim" class="anchor"></a><code><span class="keyword">val</span> remove_signature_of_raw_dkim : <span class="xref-unresolved">Unstrctrd</span>.t <span>&#45;&gt;</span> <span class="xref-unresolved">Unstrctrd</span>.t</code></div><div class="spec value" id="val-relaxed_field_canonicalization" class="anchored"><a href="#val-relaxed_field_canonicalization" class="anchor"></a><code><span class="keyword">val</span> relaxed_field_canonicalization : <span class="xref-unresolved">Mrmime</span>.Field_name.t <span>&#45;&gt;</span> <span class="xref-unresolved">Unstrctrd</span>.t <span>&#45;&gt;</span> <span>(string <span>&#45;&gt;</span> unit)</span> <span>&#45;&gt;</span> unit</code></div><div class="spec module" id="module-Body" class="anchored"><a href="#module-Body" class="anchor"></a><code><span class="keyword">module</span> <a href="Body/index.html">Body</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div></div></body></html>